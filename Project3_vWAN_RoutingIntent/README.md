## Pattern Using (Routing Intent)
This pattern is using recently annouced [Azure Virtual WAN Routing Intent](https://azure.microsoft.com/en-us/updates/general-availability-routing-intent-and-virtual-wan-integrated-firewall-nvas/) Capability.

In this repo, a sample code is being developed and testing for below high level design to build and test Routing Intent Capability across multiple Region using Secured Virtual Wan HUB (using Azure Firewall `Premium SKU`) 
<img src="/Project3_vWAN_RoutingIntent/vWAN_Routing_Intent.jpg" alt="High Level Design" width=50% height=50%>

- #### Key Facets used in this sample for code optimization
  1. [Azure Firewall Parent and Child Policy](https://learn.microsoft.com/en-us/azure/firewall-manager/policy-overview#hierarchical-policies): To bring unification on certails rules and optimize manual effort for different region Firewall Policy.
  2. [Terraform Map Function](https://developer.hashicorp.com/terraform/language/functions/map): Using Map function to automated multi region deployment and standadized it.
  3. [AzApi](https://learn.microsoft.com/en-us/azure/developer/terraform/overview-azapi-provider): As of written and tested on 26/05/2023, Azure vWAN Routing Intent does not have Terraform Provider. Therefore, AzApi is vbeing used to enable it programatically as part of Terraform Code.
  4. [Azure IP Group](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/ip_group): Extensive usage of Azure IP Groups. One of the highly recommended feature to centrally mananaged all IP prefixes than hardcoding as per of variables.
  5. Sample Ubuntu VM  with DNAT Rule: Each region Spoke VNETs with DNAT Rule for only secured inbound connection is allowed. Inject your source IP variable as part of Secret.


<!-- BEGIN_TF_DOCS -->
## Requirements (All Below Generated by [Terraform Docs](https://github.com/terraform-docs/terraform-docs))

| Name | Version |
|------|---------|
| <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) | >=1.5.0 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | >=3.55.0 |
| <a name="requirement_random"></a> [random](#requirement\_random) | >=3.1.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azapi"></a> [azapi](#provider\_azapi) | >=1.5.0 |
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | >=3.55.0 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [azapi_resource.rint](https://registry.terraform.io/providers/azure/azapi/latest/docs/resources/resource) | resource |
| [azurerm_firewall.securehub](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall) | resource |
| [azurerm_firewall_policy.child_firewall_policy](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall_policy) | resource |
| [azurerm_firewall_policy.parent_firewall_policy](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall_policy) | resource |
| [azurerm_firewall_policy_rule_collection_group.child_firewall_policy_rule](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall_policy_rule_collection_group) | resource |
| [azurerm_firewall_policy_rule_collection_group.parent_firewall_policy_rule](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/firewall_policy_rule_collection_group) | resource |
| [azurerm_ip_group.myips](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/ip_group) | resource |
| [azurerm_ip_group.spoke_vnets](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/ip_group) | resource |
| [azurerm_ip_group.vhub](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/ip_group) | resource |
| [azurerm_network_interface.vm](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface) | resource |
| [azurerm_network_interface_security_group_association.nsg_association](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface_security_group_association) | resource |
| [azurerm_network_security_group.nsg](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) | resource |
| [azurerm_resource_group.corenetworking](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [azurerm_resource_group.firewall_policy](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [azurerm_resource_group.ipgroups](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [azurerm_resource_group.vm](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [azurerm_subnet.spoke_subnets](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet) | resource |
| [azurerm_virtual_hub.vhub](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_hub) | resource |
| [azurerm_virtual_hub_connection.spoke_to_vhub](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_hub_connection) | resource |
| [azurerm_virtual_machine.vm](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_machine) | resource |
| [azurerm_virtual_network.spoke_vnets](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network) | resource |
| [azurerm_virtual_wan.wan](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_wan) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_core_location"></a> [core\_location](#input\_core\_location) | n/a | `string` | `"eastus"` | no |
| <a name="input_firewall_sku"></a> [firewall\_sku](#input\_firewall\_sku) | n/a | `string` | `"Premium"` | no |
| <a name="input_myips"></a> [myips](#input\_myips) | A list of IP addresses to allow access to the firewall | `list(string)` | n/a | yes |
| <a name="input_projectname"></a> [projectname](#input\_projectname) | n/a | `string` | `"Project2"` | no |
| <a name="input_spoke_subnets"></a> [spoke\_subnets](#input\_spoke\_subnets) | A map to create subnets for spoke vnets | <pre>map(object({<br>    name  = string<br>    cidrs = list(string)<br>  }))</pre> | n/a | yes |
| <a name="input_spoke_vnets_ip_groups"></a> [spoke\_vnets\_ip\_groups](#input\_spoke\_vnets\_ip\_groups) | A map to create ipgroups for spoke vnets | <pre>map(object({<br>    name     = string<br>    cidrs    = list(string)<br>    location = string<br>  }))</pre> | n/a | yes |
| <a name="input_vhub_ip_groups"></a> [vhub\_ip\_groups](#input\_vhub\_ip\_groups) | A map to create ipgroups | <pre>map(object({<br>    name     = string<br>    cidrs    = list(string)<br>    location = string<br>  }))</pre> | n/a | yes |

## Outputs

No outputs.
<!-- END_TF_DOCS -->